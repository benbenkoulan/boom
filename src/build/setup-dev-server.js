const path = require('path');
const webpack = require('webpack');
const MFS = require('memory-fs');
const clientConfig = require('./webpack.client.config');
const serverConfig = require('./webpack.server.config');

module.exports = (app, cb) => {
	let clientManifest,
		bundle,
		resolve;

	const readyPromise = new Promise(r => {
		resolve = r;
	});
	const ready = (...args) => {
		resolve();
		cb(...args);
	}

	const getReadFile = (fs, outputPath) => file => fs.readFileSync(path.join(outputPath, file), 'utf-8');
	clientConfig.entry.main.push('webpack-hot-middleware/client');
	clientConfig.entry.vender.push('webpack-hot-middleware/client');
	clientConfig.plugins.push(new webpack.HotModuleReplacementPlugin(), new webpack.NoEmitOnErrorsPlugin());//引入热模块替换插件


  	// dev middleware
  	const clientCompiler = webpack(clientConfig);
  	const clientDevMiddleware = require('webpack-dev-middleware')(clientCompiler, {
  		publicPath: clientConfig.output.publicPath,
  		noInfo: true
  	});

  	app.use(clientDevMiddleware);

  	clientCompiler.plugin('done', () => {
  		const readFile = getReadFile(clientDevMiddleware.fileSystem, clientConfig.output.path);

  		clientManifest = JSON.parse(readFile('vue-ssr-client-manifest.json'));
  		console.log('----clientManifest--------------');
  		if(bundle){
  			ready(bundle, {
  				clientManifest
  			});
  		}
  		console.log('----clientManifest-------end-------');
  	});

  	//hot middleware
  	app.use(require('webpack-hot-middleware')(clientCompiler));


  	//watch and update server renderer
  	const serverCompiler = webpack(serverConfig);
  	const mfs = new MFS();
  	serverCompiler.outputFileSystem = mfs;
  	serverCompiler.watch({}, (err, status) => {
  		if(err) {
  			console.log('------------------server--compile--------');
  			console.log(err);
  			console.log('------------------end------server-----compile------');
  			return;
  		}
  		status = status.toJson();
	    status.errors.forEach(err => console.error(err));
	    status.warnings.forEach(err => console.warn(err));
	    const readFile = getReadFile(mfs, clientConfig.output.path);
	    // read bundle generated by vue-ssr-webpack-plugin
    	bundle = JSON.parse(readFile('vue-ssr-server-bundle.json'))
	    console.log('----serverManifest--------------');
	    if(clientManifest){
	    	ready(bundle, {
	    		clientManifest
	    	})
	    }
	    console.log('----serverManifest-----end---------');
  	});
  	return readyPromise;
}